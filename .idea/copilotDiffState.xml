<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/components/Chat.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/components/Chat.tsx" />
              <option name="originalContent" value="&quot;use client&quot;;&#10;&#10;// Импорт React и хуков useState&#10;import React, { useState } from 'react';&#10;// Импорт компонента для отображения сообщений&#10;import { Message } from './Message';&#10;// Импорт компонента для ввода сообщений&#10;import { Input } from './Input';&#10;&#10;// Типизация одного сообщения чата&#10;interface ChatMessage {&#10;  role: 'user' | 'assistant'; // Роль отправителя: пользователь или ассистент&#10;  content: string;           // Текст сообщения&#10;}&#10;&#10;// Интерфейс для статистики&#10;interface Stats {&#10;  inputTokens: number;&#10;  outputTokens: number;&#10;  cost: number;&#10;  maxTokens: number;&#10;}&#10;&#10;// Основной компонент чата&#10;export const Chat: React.FC = () =&gt; {&#10;  // Состояние: массив сообщений&#10;  const [messages, setMessages] = useState&lt;ChatMessage[]&gt;([]);&#10;  // Состояние: индикатор загрузки (ожидание ответа)&#10;  const [loading, setLoading] = useState(false);&#10;  // Состояние: статистика токенов и стоимости&#10;  const [stats, setStats] = useState&lt;Stats&gt;({&#10;    inputTokens: 0,&#10;    outputTokens: 0,&#10;    cost: 0,&#10;    maxTokens: 1024,&#10;  });&#10;  // Ссылка на конец списка сообщений для автоскролла&#10;  const messagesEndRef = React.useRef&lt;HTMLDivElement&gt;(null);&#10;&#10;  // Загружаем сообщения из localStorage при инициализации&#10;  React.useEffect(() =&gt; {&#10;    const saved = localStorage.getItem('chat_messages');&#10;    if (saved) {&#10;      try {&#10;        setMessages(JSON.parse(saved));&#10;      } catch {}&#10;    }&#10;  }, []);&#10;&#10;  // Сохраняем сообщения в localStorage при каждом изменении&#10;  React.useEffect(() =&gt; {&#10;    localStorage.setItem('chat_messages', JSON.stringify(messages));&#10;  }, [messages]);&#10;&#10;  // Функция отправки сообщения&#10;  const sendMessage = async (message: string) =&gt; {&#10;    // Добавляем сообщение пользователя в чат&#10;    setMessages(prev =&gt; [...prev, { role: 'user', content: message }]);&#10;    setLoading(true); // Включаем индикатор загрузки&#10;    try {&#10;      // Отправляем запрос к API-роуту DeepSeek&#10;      const res = await fetch('/api/deepseek', {&#10;        method: 'POST',&#10;        headers: { 'Content-Type': 'application/json' },&#10;        body: JSON.stringify({ message }),&#10;      });&#10;      // Получаем ответ от нейросети&#10;      const data = await res.json();&#10;      // Логируем полный ответ нейросети&#10;      console.log('Ответ DeepSeek:', data);&#10;      // Корректный расчёт стоимости токенов по тарифам DeepSeek&#10;      const inputCost = (data.usage?.prompt_tokens || 0) * 0.000028; // cache hit&#10;      const outputCost = (data.usage?.completion_tokens || 0) * 0.00042;&#10;      setStats({&#10;        inputTokens: data.usage?.prompt_tokens || 0,&#10;        outputTokens: data.usage?.completion_tokens || 0,&#10;        cost: inputCost + outputCost,&#10;        maxTokens: data.model_max_tokens || 1024,&#10;      });&#10;      // Извлекаем текст ответа ассистента&#10;      const answer = data.choices?.[0]?.message?.content || 'Нет ответа';&#10;      // Добавляем ответ ассистента в чат&#10;      setMessages(prev =&gt; [...prev, { role: 'assistant', content: answer }]);&#10;    } catch {&#10;      // В случае ошибки добавляем сообщение об ошибке&#10;      setMessages(prev =&gt; [...prev, { role: 'assistant', content: 'Ошибка соединения с DeepSeek.' }]);&#10;    } finally {&#10;      setLoading(false); // Отключаем индикатор загрузки&#10;    }&#10;  };&#10;&#10;  // Эффект для автоскролла к последнему сообщению&#10;  React.useEffect(() =&gt; {&#10;    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });&#10;  }, [messages, loading]);&#10;&#10;  // Рендеринг интерфейса чата&#10;  return (&#10;    &lt;div className=&quot;flex w-full h-full max-w-[960px] mx-auto gap-8 py-8&quot;&gt;&#10;      {/* Окно чата */}&#10;      &lt;div className=&quot;flex flex-col h-full w-full bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200&quot;&gt;&#10;        &lt;div className=&quot;flex-1 overflow-y-auto p-6&quot;&gt;&#10;          {messages.map((msg, idx) =&gt; (&#10;            &lt;Message key={idx} role={msg.role} content={msg.content} /&gt;&#10;          ))}&#10;          {loading &amp;&amp; &lt;Message role=&quot;assistant&quot; content=&quot;...&quot; /&gt;}&#10;          &lt;div ref={messagesEndRef} /&gt;&#10;        &lt;/div&gt;&#10;        &lt;Input onSend={sendMessage} loading={loading} /&gt;&#10;      &lt;/div&gt;&#10;      {/* Окно статистики */}&#10;      &lt;aside className=&quot;w-80 min-w-[260px] h-full bg-gradient-to-b from-blue-50 to-zinc-100 border border-gray-200 rounded-2xl shadow-lg flex flex-col items-center px-8 py-10&quot;&gt;&#10;        &lt;h2 className=&quot;text-xl font-bold mb-8 text-blue-700&quot;&gt;Статистика&lt;/h2&gt;&#10;        &lt;div className=&quot;flex flex-col gap-6 w-full&quot;&gt;&#10;          &lt;div className=&quot;flex flex-col items-start&quot;&gt;&#10;            &lt;span className=&quot;font-semibold text-gray-700&quot;&gt;Входящие токены:&lt;/span&gt;&#10;            &lt;span className=&quot;text-lg font-mono text-black&quot;&gt;{stats.inputTokens}&lt;/span&gt;&#10;          &lt;/div&gt;&#10;          &lt;div className=&quot;flex flex-col items-start&quot;&gt;&#10;            &lt;span className=&quot;font-semibold text-gray-700&quot;&gt;Исходящие токены:&lt;/span&gt;&#10;            &lt;span className=&quot;text-lg font-mono text-black&quot;&gt;{stats.outputTokens}&lt;/span&gt;&#10;          &lt;/div&gt;&#10;          &lt;div className=&quot;flex flex-col items-start&quot;&gt;&#10;            &lt;span className=&quot;font-semibold text-gray-700&quot;&gt;Стоимость:&lt;/span&gt;&#10;            &lt;span className=&quot;text-lg font-mono text-green-700&quot;&gt;{stats.cost.toFixed(6)} $&lt;/span&gt;&#10;          &lt;/div&gt;&#10;          &lt;div className=&quot;flex flex-col items-start&quot;&gt;&#10;            &lt;span className=&quot;font-semibold text-gray-700&quot;&gt;Максимальный лимит токенов:&lt;/span&gt;&#10;            &lt;span className=&quot;text-lg font-mono text-black&quot;&gt;{stats.maxTokens}&lt;/span&gt;&#10;          &lt;/div&gt;&#10;        &lt;/div&gt;&#10;      &lt;/aside&gt;&#10;    &lt;/div&gt;&#10;  );&#10;};&#10;" />
              <option name="updatedContent" value="&quot;use client&quot;;&#10;&#10;// Импорт React и хуков useState, useRef, useEffect&#10;import React, { useState, useRef, useEffect } from 'react';&#10;// Импорт компонента для отображения сообщений&#10;import { Message } from './Message';&#10;// Импорт компонента для ввода сообщений&#10;import { Input } from './Input';&#10;&#10;// Типизация одного сообщения чата&#10;interface ChatMessage {&#10;  role: 'user' | 'assistant'; // Роль отправителя: пользователь или ассистент&#10;  content: string;           // Текст сообщения&#10;}&#10;&#10;// Интерфейс для статистики&#10;interface Stats {&#10;  inputTokens: number;&#10;  outputTokens: number;&#10;  cost: number;&#10;  maxTokens: number;&#10;}&#10;&#10;// Основной компонент чата&#10;export const Chat: React.FC = () =&gt; {&#10;  // Состояние: массив сообщений&#10;  const [messages, setMessages] = useState&lt;ChatMessage[]&gt;([]);&#10;  // Состояние: индикатор загрузки (ожидание ответа)&#10;  const [loading, setLoading] = useState(false);&#10;  // Состояние: статистика токенов и стоимости&#10;  const [stats, setStats] = useState&lt;Stats&gt;({&#10;    inputTokens: 0,&#10;    outputTokens: 0,&#10;    cost: 0,&#10;    maxTokens: 1024,&#10;  });&#10;  // Ссылка на конец списка сообщений для автоскролла&#10;  const messagesEndRef = useRef&lt;HTMLDivElement&gt;(null);&#10;&#10;  // Загружаем сообщения из localStorage при инициализации&#10;  useEffect(() =&gt; {&#10;    const saved = localStorage.getItem('chat_messages');&#10;    if (saved) {&#10;      try {&#10;        setMessages(JSON.parse(saved));&#10;      } catch {}&#10;    }&#10;  }, []);&#10;&#10;  // Сохраняем сообщения в localStorage при каждом изменении&#10;  useEffect(() =&gt; {&#10;    localStorage.setItem('chat_messages', JSON.stringify(messages));&#10;  }, [messages]);&#10;&#10;  // Функция отправки сообщения&#10;  const sendMessage = async (message: string) =&gt; {&#10;    // Добавляем сообщение пользователя в чат&#10;    setMessages(prev =&gt; [...prev, { role: 'user', content: message }]);&#10;    setLoading(true); // Включаем индикатор загрузки&#10;    try {&#10;      // Отправляем запрос к API-роуту DeepSeek&#10;      const res = await fetch('/api/deepseek', {&#10;        method: 'POST',&#10;        headers: { 'Content-Type': 'application/json' },&#10;        body: JSON.stringify({ message }),&#10;      });&#10;      // Получаем ответ от нейросети&#10;      const data = await res.json();&#10;      // Логируем полный ответ нейросети&#10;      console.log('Ответ DeepSeek:', data);&#10;      // Корректный расчёт стоимости токенов по тарифам DeepSeek&#10;      const inputCost = (data.usage?.prompt_tokens || 0) * 0.000028; // cache hit&#10;      const outputCost = (data.usage?.completion_tokens || 0) * 0.00042;&#10;      setStats({&#10;        inputTokens: data.usage?.prompt_tokens || 0,&#10;        outputTokens: data.usage?.completion_tokens || 0,&#10;        cost: inputCost + outputCost,&#10;        maxTokens: data.model_max_tokens || 1024,&#10;      });&#10;      // Извлекаем текст ответа ассистента&#10;      const answer = data.choices?.[0]?.message?.content || 'Нет ответа';&#10;      // Добавляем ответ ассистента в чат&#10;      setMessages(prev =&gt; [...prev, { role: 'assistant', content: answer }]);&#10;    } catch (err) {&#10;      // В случае ошибки добавляем сообщение об ошибке&#10;      console.error('Ошибка при запросе к DeepSeek', err);&#10;      setMessages(prev =&gt; [...prev, { role: 'assistant', content: 'Ошибка соединения с DeepSeek.' }]);&#10;    } finally {&#10;      setLoading(false); // Отключаем индикатор загрузки&#10;    }&#10;  };&#10;&#10;  // Эффект для автоскролла к последнему сообщению&#10;  useEffect(() =&gt; {&#10;    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });&#10;  }, [messages, loading]);&#10;&#10;  // Рендеринг интерфейса чата&#10;  return (&#10;    // Контейнер на всю высоту окна, адаптивный: столбец на мобильных, два столбца на больших экранах&#10;    &lt;div className=&quot;flex flex-col lg:flex-row w-full h-screen max-w-[1200px] mx-auto gap-6 py-8 px-4&quot;&gt;&#10;&#10;      {/* Окно чата */}&#10;      &lt;div className=&quot;flex flex-col flex-1 min-h-0 bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200&quot;&gt;&#10;        {/* Заголовок чата (sticky) */}&#10;        &lt;header className=&quot;px-6 py-4 bg-white border-b sticky top-0 z-10&quot;&gt;&#10;          &lt;h1 className=&quot;text-lg font-semibold text-black&quot;&gt;DeepSeek Chat&lt;/h1&gt;&#10;          &lt;p className=&quot;text-sm text-gray-500&quot;&gt;Общайтесь с нейросетью — история сохраняется локально&lt;/p&gt;&#10;        &lt;/header&gt;&#10;&#10;        {/* Содержимое сообщений */}&#10;        &lt;div className=&quot;flex-1 overflow-y-auto p-6 space-y-3 bg-gradient-to-b from-white to-gray-50&quot;&gt;&#10;          {messages.length === 0 &amp;&amp; (&#10;            &lt;div className=&quot;text-center text-gray-500 mt-12&quot;&gt;Начните разговор — введите сообщение внизу&lt;/div&gt;&#10;          )}&#10;&#10;          {messages.map((msg, idx) =&gt; (&#10;            &lt;Message key={idx} role={msg.role} content={msg.content} /&gt;&#10;          ))}&#10;&#10;          {loading &amp;&amp; &lt;Message role=&quot;assistant&quot; content=&quot;...&quot; /&gt;}&#10;&#10;          &lt;div ref={messagesEndRef} /&gt;&#10;        &lt;/div&gt;&#10;&#10;        {/* Поле ввода (внизу, не sticky) */}&#10;        &lt;div className=&quot;bg-white border-t&quot;&gt;&#10;          &lt;Input onSend={sendMessage} loading={loading} /&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      {/* Разделитель визуальный (на больших экранах) */}&#10;      &lt;div className=&quot;hidden lg:block w-px bg-gray-200&quot; /&gt;&#10;&#10;      {/* Окно статистики */}&#10;      &lt;aside className=&quot;w-full lg:w-80 min-w-[240px] max-w-[320px] h-full bg-gradient-to-b from-blue-50 to-zinc-100 border border-gray-200 rounded-2xl shadow-lg flex flex-col px-6 py-6&quot;&gt;&#10;        &lt;div className=&quot;sticky top-6&quot;&gt;&#10;          &lt;h2 className=&quot;text-xl font-bold mb-2 text-blue-700&quot;&gt;Статистика&lt;/h2&gt;&#10;          &lt;p className=&quot;text-sm text-gray-600 mb-4&quot;&gt;Токены и стоимость (примерно)&lt;/p&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div className=&quot;flex-1 overflow-y-auto w-full&quot;&gt;&#10;          &lt;div className=&quot;grid gap-4&quot;&gt;&#10;            &lt;div className=&quot;p-4 bg-white rounded-lg border&quot;&gt;&#10;              &lt;div className=&quot;text-sm text-gray-500&quot;&gt;Входящие токены&lt;/div&gt;&#10;              &lt;div className=&quot;mt-1 text-lg font-mono text-black&quot;&gt;{stats.inputTokens}&lt;/div&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div className=&quot;p-4 bg-white rounded-lg border&quot;&gt;&#10;              &lt;div className=&quot;text-sm text-gray-500&quot;&gt;Исходящие токены&lt;/div&gt;&#10;              &lt;div className=&quot;mt-1 text-lg font-mono text-black&quot;&gt;{stats.outputTokens}&lt;/div&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div className=&quot;p-4 bg-white rounded-lg border&quot;&gt;&#10;              &lt;div className=&quot;text-sm text-gray-500&quot;&gt;Стоимость&lt;/div&gt;&#10;              &lt;div className=&quot;mt-1 text-lg font-mono text-green-700&quot;&gt;{stats.cost.toFixed(6)} $&lt;/div&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div className=&quot;p-4 bg-white rounded-lg border&quot;&gt;&#10;              &lt;div className=&quot;text-sm text-gray-500&quot;&gt;Максимальный лимит токенов&lt;/div&gt;&#10;              &lt;div className=&quot;mt-1 text-lg font-mono text-black&quot;&gt;{stats.maxTokens}&lt;/div&gt;&#10;            &lt;/div&gt;&#10;          &lt;/div&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;div className=&quot;pt-4 sticky bottom-6 bg-transparent&quot;&gt;&#10;          &lt;button&#10;            className=&quot;w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700&quot;&#10;            onClick={() =&gt; {&#10;              // Очистка истории и статистики&#10;              setMessages([]);&#10;              setStats({ inputTokens: 0, outputTokens: 0, cost: 0, maxTokens: 1024 });&#10;              localStorage.removeItem('chat_messages');&#10;            }}&#10;          &gt;&#10;            Очистить историю&#10;          &lt;/button&gt;&#10;        &lt;/div&gt;&#10;      &lt;/aside&gt;&#10;    &lt;/div&gt;&#10;  );&#10;};" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>